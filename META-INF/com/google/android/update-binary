#!/sbin/sh

# Экран дисплея
SCREEN=/proc/self/fd/$2

# Текущий установщик zip
ZIPFILE="$3"

# Пути к устройствам и файлам
device="/dev/block/mmcblk0"
sgdisk="/tmp/sgdisk"
boot="/tmp/boot.img"

# Вывод сообщений 
ui_print() {
echo -e "ui_print $1\nui_print" >> $SCREEN
}

# Отображение 
display() {
ui_print " "
ui_print "=========================================="
ui_print "         Repartitioning partitions        "
ui_print "                 By isus203               "
ui_print "=========================================="
ui_print " "
}

# Функция проверки ошибок
check_error() {
    if [ $? -ne 0 ]; then
        ui_print " "
        ui_print "Error: command failed with exit code $?"
        ui_print " "
        exit 1
    fi
}

# Проверка директории и распаковка
directory_check() {
    if [ -e /tmp ]; then
        ui_print " "
        ui_print "Unpacking archive"
        unzip -o "$ZIPFILE" -d /tmp
        check_error
    else
        ui_print " "
        ui_print "Creating a directory and unpacking the archive" 
        mkdir -p /tmp
        unzip -o "$ZIPFILE" -d /tmp
        check_error
    fi
}

# Проверяем существование файлов
checking_package_existence() {
    if [ ! -e /tmp/* ]; then
        ui_print " "
        ui_print "Packages in /tmp not found. Make sure the files are in the /tmp directory."
        check_error
    fi
}

# Выдача разрешений
issuance_of_permits() {
    ui_print " "
    ui_print "Issuance of permits"
    ui_print " "
    chmod 777 $sgdisk
    chmod 777 $boot
}

# Переразметка
re-markup() {
    ui_print "Repartition boot"
    $sgdisk $device -d 34 -d 35 -n 34:158976:183551 -c 34:boot_a -t 34:0700
    check_error
    $sgdisk $device -d 50 -d 51 -n 50:267520:292095 -c 50:boot_b -t 50:0700
    #check_error
    $sgdisk $device -s
    check_error
    ui_print " "
    ui_print "Re-marking is finished"
}

# Прошивание
firmware() {
    ui_print " "
    ui_print "Flashing boot"
    dd if="$boot" of="/dev/block/by-name/boot_a"
    check_error
    dd if="$boot" of="/dev/block/by-name/boot_b"
    check_error
    ui_print " "
    ui_print "Firmware is complete"
    ui_print " "
}

ui_print
display
directory_check
checking_package_existence
issuance_of_permits
re-markup
firmware
